#
# Copyright (C) 2013-2018 University of Amsterdam
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#

msaTestRetest <- function(jaspResults, dataset, options, ...) {


  if (options[["testRetestDataFormat"]] == "testRetestWideFormat"){
    measurements <- unlist(options$measurements)
  }else{
    measurements <- unlist(options$measurementsLong)
  }
  parts <- unlist(options$parts)
  operators <- unlist(options$operators)

  numeric.vars <- measurements
  numeric.vars <- numeric.vars[numeric.vars != ""]
  factor.vars <- c(parts, operators)
  factor.vars <- factor.vars[factor.vars != ""]

  if (options[["testRetestDataFormat"]] == "testRetestWideFormat"){
    ready <- (length(measurements) > 1 && parts != "")
  }else{
    ready <- (measurements != "" && operators != "" && parts != "")
  }

  if (is.null(dataset)) {
    dataset         <- .readDataSetToEnd(columns.as.numeric  = numeric.vars, columns.as.factor = factor.vars,
                                         exclude.na.listwise = c(numeric.vars, factor.vars))
  }

  if (options[["testRetestDataFormat"]] == "testRetestLongFormat" && ready){
    wideData <- tidyr::spread(dataset, operators, measurements)
    measurements <- colnames(wideData)
    measurements <- measurements[measurements != parts]
    dataset <- wideData
  }


  .msaCheckErrors(dataset, options)

  # Range Method

    # Range Method r and R table
    if (options[["rangeRr"]]) {
      .rAndRtableRange(dataset = dataset, measurements = measurements, parts = parts, operators = operators, options =  options, jaspResults, ready = ready)
    }

    # Scatter Plot Operators vs Parts
    if (options[["rangeScatterPlotOperatorParts"]]) {
      if (is.null(jaspResults[["ScatterOperatorParts"]])) {
        jaspResults[["ScatterOperatorParts"]] <- createJaspContainer(gettext("Scatterplot Operators vs Parts"))
        jaspResults[["ScatterOperatorParts"]]$position <- 9
      }
      jaspResults[["ScatterOperatorParts"]] <- .ScatterPlotOperatorParts(dataset = dataset, measurements = measurements, parts = parts, operators = operators, options =  options, ready = ready)
    }

    # Rchart Range method
    if (options[["rangeRchart"]]) {
      if (is.null(jaspResults[["rangeRchart"]])) {
        jaspResults[["rangeRchart"]] <- createJaspContainer(gettext("Range Method R Chart"))
        jaspResults[["rangeRchart"]]$position <- 11
      }
      plot <- createJaspPlot(title = gettext("Range chart by part"), width = 600, height = 300)
      plot$dependOn(c("rangeRchart"))
      p <- .RchartNoId(dataset = dataset[measurements], options = options, warningLimits = FALSE)$p
      plot$plotObject <- p
      jaspResults[["rangeRchart"]] <- plot
    }

  # Scatter Plot Operators
  if (options[["rangeScatterPlotOperators"]]) {
    if (is.null(jaspResults[["ScatterOperators"]])) {
      jaspResults[["ScatterOperators"]] <- createJaspContainer(gettext("Scatterplot Operators"))
      jaspResults[["ScatterOperators"]]$position <- 10
    }
    jaspResults[["ScatterOperators"]] <- .ScatterPlotOperators(dataset = dataset, measurements = measurements, parts = parts, operators = operators, options =  options, ready = ready)
  }


  return()
}





.ScatterPlotOperatorParts <- function(dataset, measurements, parts, operators, options, ready) {


  plot <- createJaspPlot(title = gettext("Runchart of parts"), width = 500, height = 320)
  plot$dependOn(c("rangeScatterPlotOperatorParts"))

  if (ready) {
    partIndex <- 1:length(dataset[[measurements[1]]])
    dataset <- cbind(dataset, Parts = factor(partIndex, partIndex))

    allMeasurements <- as.vector(unlist(dataset[measurements]))
    yBreaks <- jaspGraphs::getPrettyAxisBreaks(allMeasurements)
    yLimits <- range(yBreaks)

    p <- ggplot2::ggplot() +
      jaspGraphs::geom_point(data = dataset, ggplot2::aes_string(x = "Parts", y = measurements[1], group = 1), fill = "red",  size = 4) +
      jaspGraphs::geom_point(data = dataset, ggplot2::aes_string(x = "Parts", y = measurements[2], group = 2),fill = "green", shape = 22, size = 4) +
      ggplot2::scale_y_continuous(name = "Measurements", limits = yLimits, breaks = yBreaks)

    p <- jaspGraphs::themeJasp(p) + ggplot2::theme(legend.position = "right")

    plot$plotObject <- p
  }

  return(plot)
}

.rAndRtableRange <- function(dataset, measurements, parts, operators, options, jaspResults, ready) {

  table <- createJaspTable(title = gettext("Short gauge study"))
  table$position <- 2
  table$dependOn(c("rangeRr", "gaugeRRmethod"))

  table$addColumnInfo(name = "n", title = gettext("Sample size (n)"), type = "integer")
  table$addColumnInfo(name = "Rbar", title = gettext("R-bar"), type = "number")
  table$addColumnInfo(name = "d2", title = gettext("d2"), type = "number")
  table$addColumnInfo(name = "PSD", title = gettext("Process Std. Dev."), type = "number")
  table$addColumnInfo(name = "GRR", title = gettext("GRR"), type = "number")
  table$addColumnInfo(name = "GRRpercent", title = gettext("%GRR"), type = "number")

  jaspResults[["rAndR2"]] <- table

  if (ready) {
    n <- length(dataset[[measurements[1]]])
    Rbar <- sum(abs(dataset[measurements[1]] - dataset[measurements[2]]) / n)
    d2 <- .d2Value(n)
    SD <- options$rangePSD
    GRR <- Rbar/d2
    GRRpercent <- GRR/SD*100


    table$addRows(list(      "n"          = n,
                             "Rbar"       = Rbar,
                             "d2"         = d2,
                             "PSD"        = SD,
                             "GRR"        = GRR,
                             "GRRpercent" = GRRpercent))
  }
}

.ScatterPlotOperators <- function(dataset, measurements, parts, operators, options, ready) {

  plot <- createJaspPlot(title = gettext("Scatterplot of Operator A vs Operator B"))
  plot$dependOn(c("rangeScatterPlotOperators", "rangeScatterPlotFitLine", "rangeScatterPlotOriginLine", "gaugeRRmethod"))

  if (ready) {

    p <- ggplot2::ggplot(data = dataset, ggplot2::aes_string(x = measurements[1], y = measurements[2])) +
      jaspGraphs::geom_point() + ggplot2::scale_x_continuous(limits = c(min(dataset[measurements])*0.9,max(dataset[measurements])*1.1)) +
      ggplot2::scale_y_continuous(limits = c(min(dataset[measurements])*0.9,max(dataset[measurements])*1.1))

    if (options[["rangeScatterPlotFitLine"]])
      p <- p + ggplot2::geom_smooth(method = "lm", se = FALSE)

      p <- p + ggplot2::geom_abline(col = "gray", linetype = "dashed")

    p <- jaspGraphs::themeJasp(p)

    plot$plotObject <- p

  }

  return(plot)
}

.d2Value <- function(n) {
  d2table <- data.frame(n = 1:20, d2 = c(1.41421, 1.27931, 1.23105, 1.20621, 1.19105, 1.18083, 1.17348, 1.16794, 1.16361, 1.16014,
                                         1.15729, 1.15490, 1.15289, 1.15115, 1.14965, 1.14833, 1.14717, 1.14613, 1.14520, 1.14437))
  if(n <= 20){
    return(d2table$d2[d2table$n == n])
  }else{
    return(1.12838)
  }
}

